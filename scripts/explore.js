document.addEventListener("alpine:init", () => {
  // Story API
  const story_api = () => [
    {
      _id: 1,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 300,
          duration: 10,
          img: "https://picsum.photos/900/500",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "https://picsum.photos/1400/1200",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/1.png",
        name: "Olivia Rhye",
      },
    },
    {
      _id: 2,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 250,
          duration: 10,
          img: "../images/story-img/3.png",
          caption: "Good morning to you all",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 1500,
          duration: 10,
          img: "../videos/vid.mp4",
          caption: "As Salam Alaikum. TGIF ",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/story-img/5.png",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/videos/1.mp4",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 800,
          duration: 10,
          img: "../images/lives/22.png",
          caption: "Good morning to you all",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/videos/3.mp4",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/lives/25.png",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/videos/4.mp4",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/videos/2.mp4",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/2.png",
        name: "Gorge Yussuf",
      },
    },
    {
      _id: 3,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/lives/22.png",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 200,
          duration: 10,
          img: "../images/videos/5.mp4",
          caption: "Good morning to you all",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/videos/6.mp4",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/3.png",
        name: "Hammed Osiofit",
      },
    },
    {
      _id: 4,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 700,
          duration: 10,
          img: "../images/lives/17.jpg",
          caption: "As Salam Alaikum. TGIF ",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 700,
          duration: 10,
          img: "../images/videos/6.mp4",
          caption: "Good morning to you all",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/lives/18.webp",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/lives/19.jpg",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/4.png",
        name: "Abdulakeem Oladimeji",
      },
    },
    {
      _id: 5,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/lives/21.webp",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 500,
          duration: 10,
          img: "../images/lives/20.jpg",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/5.png",
        name: "Abdulakeem Oladimeji",
      },
    },
    {
      _id: 6,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/lives/22.png",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 700,
          duration: 10,
          img: "../images/lives/23.png",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/6.png",
        name: "CSC Oladimeji",
      },
    },
    {
      _id: 7,
      media: [
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 400,
          duration: 10,
          img: "../images/lives/24.png",
          caption: "Click the link below to join the free workshop before it gets filled up",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 700,
          duration: 10,
          img: "../images/lives/25.png",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
        {
          sid: null,
          count: 0,
          elementId() {
            return `progress_`;
          },
          max_duration: 700,
          duration: 10,
          img: "../images/lives/26.png",
          caption: "Would you like to discover the Brand new way to create and Edit PRO videos that makes money in 2024 using just your smartphone? ",
        },
      ],
      len() {
        return this.media.length;
      },
      sender: {
        image: "../images/small-img/6.png",
        name: "CSC Oladimeji",
      },
    },
  ];

  Alpine.data("view_story", () => ({
    live_tab: 1,
    story_pause: false,
    current_story_index: 0,
    current_media_index: 0,
    countId: 1,
    story_active_media: "",
    preloader: true,
    story_ctrl: true,
    current_story() {
      let __stories = Object.keys(this.stories);
      return __stories[this.current_story_index] !== undefined ? __stories[this.current_story_index] : false;
    },
    startY: 0,
    onTouchStart(event) {
      this.startY = event.touches[0].clientY;
    },
    onTouchEnd(event) {
      const endY = event.changedTouches[0].clientY;
      const diffY = this.startY - endY;
      if (diffY > 30) {
        this.onSwipeUp();
      }
    },
    onSwipeUp() {},

    /* Story */
    startY_control_ctrl: 0,
    onTouchStart_control_ctrl(event) {
      this.startY_control_ctrl = event.touches[0].clientY;
    },
    onTouchEnd_control_ctrl(event) {
      const endY = event.changedTouches[0].clientY;
      const diffY = this.startY_control_ctrl - endY;
      if (diffY > 30) {
        this.onSwipeUp_control_ctrl();
      }
      if (diffY < -90) {
        this.story_active_media = "";
        this.stories = {};
        let story_modal = document.querySelector(".story_modal");
        story_modal.style.transform = "translateY(100%)";
      }
    },
    onSwipeUp_control_ctrl() {
      if (window.innerWidth <= 640) {
        this.story_ctrl = true;
      }
    },
    current_media() {
      let __media = Object.keys(this.stories[this.current_story_index].media);
      return __media[this.current_media_index] !== undefined ? __media[this.current_media_index] : false;
    },
    fetch_media() {
      if (Object.keys(this.stories).length) {
        let __media = Object.values(this.stories[this.current_story_index]?.media);
        return __media[this.current_media_index]?.img;
      }
      return false;
    },
    no_story: {
      ["x-show"]() {
        return !Object.keys(this.stories).length;
      },
    },
    control_story: {
      ["x-class"]() {
        return this.live_tab == 2 ? "control_story_tablet" : "";
      },
      ["x-show"]() {
        if (window.innerWidth <= 640) {
          // return this.story_ctrl;
        }
        return true;
      },
      ["x-init"]() {
        this.$watch("story_ctrl", (value) => {
          if (window.innerWidth <= 640) {
            if (value) this.$el.style.transform = "translateY(0%)";
            if (!value) this.$el.style.transform = "translateY(100%)";
          }
        });
      },
      ["x-on:click.self"]() {
        this.story_ctrl = false;
      },
    },
    fetch_stories() {
      return story_api();
    },
    fetch_user_details() {
      if (Object.keys(this.stories).length) {
        let __story = Object.values(this.stories);
        return __story[this.current_story_index].sender;
      }
      return false;
    },
    fetch_media_caption() {
      if (Object.keys(this.stories).length) {
        let __media = Object.values(this.stories[this.current_story_index]?.media);
        return __media[this.current_media_index]?.caption;
      }
      return "";
    },
    stories: {},
    startMedia(callback) {
      let media = { ...this.stories[this.current_story()].media[this.current_media()] };
      if (!media.sid) {
        this.story_active_media = media?.img;
        this.countId = setInterval(() => {
          if (media.count > media.max_duration) {
            media.count = 0;
          }
          media.sid = this.countId;
          media.count++;

          if (Object.keys(this.stories).length) {
            this.stories[this.current_story()].media[this.current_media()] = { ...media };
            if (media.count == media.max_duration) {
              this.pauseStory(this.current_story(), this.current_media());
              callback();
            }
          }
        }, media.duration);
      }
    },
    startAllStories(callback) {
      if (this.current_media()) {
        this.startMedia(() => {
          this.current_media_index++;
          this.startAllStories();
        });
      } else {
        clearInterval();
        this.current_media_index = 0;
        this.stories = {};
        this.$refs.story_progress.innerHTML = "";
        // callback();
      }
    },
    pauseStory(story_index, media_index) {
      if (this.stories[story_index].media[media_index].sid) {
        clearInterval(this.stories[story_index].media[media_index].sid);
        this.stories[story_index].media[media_index].sid = null;
      }
    },
    pp_media: {
      ["x-text"]() {
        return this.stories[this.current_story()]?.media[this.current_media()]?.count;
      },
    },
    load_image(imageUrl) {
      setTimeout(() => {
        this.story_pause = true;
        this.preloader = true;
      }, 10);
      return new Promise((res, rej) => {
        fetch(imageUrl)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.blob();
          })
          .then((blob) => {
            const imageObjectURL = URL.createObjectURL(blob);
            const fileType = blob.type;

            // Determine if it's an image or a video based on the file type

            let media = "";
            if (fileType.startsWith("image/")) {
              media = document.createElement("img");
            } else if (fileType.startsWith("video/")) {
              media = document.createElement("video");
              media.id = "media_video";
              media.control = false;
              media.autoplay = true;
            } else {
              rej();
            }
            media.src = imageObjectURL;
            media.alt = "Story Image";
            // Create an img element

            setTimeout(() => {
              this.story_pause = false;
              this.preloader = false;
              res(media);
            }, 10);
          })
          .catch((error) => {
            console.error("There has been a problem with your fetch operation:", error);
            rej("There has been a problem with your fetch operation:");
          });
      });
    },
    story_media: {
      async ["x-bind:html"]() {
        this.$el.innerHTML = "";
        if (this.story_active_media == "") return "";
        let fetched_img = await this.load_image(this.story_active_media);
        this.$el.appendChild(fetched_img);
      },
      ["x-on:click"]() {
        let vid_player = this.$el.querySelector("video");
        this.story_pause = !this.story_pause;
        if (vid_player) {
          if (this.story_pause) {
            vid_player.pause();
          } else {
            vid_player.play();
          }
        }
      },
    },
    progress_item: {
      ["x-on:click.self"]() {
        let cm_id = this.$el.getAttribute("data-id");
        this.modify_active_media(cm_id);
      },
    },
    modify_active_media(cm_id) {
      this.stories[this.current_story()].media[this.current_media()].sid = null;
      this.story_active_media = "";
      for (let i = 0; i < Object.keys(this.stories[this.current_story()].media).length; i++) {
        if (cm_id > i) {
          this.stories[this.current_story()].media[i].count = this.stories[this.current_story()].media[i].max_duration;
        } else {
          this.stories[this.current_story()].media[i].count = 0;
        }
      }
      this.current_media_index = cm_id;
      clearInterval(this.countId);
      this.startAllStories();
    },
    previous_media: {
      ["x-on:click"]() {
        let media_index = 0;
        if (this.current_media_index > 0) {
          media_index = this.current_media_index - 1;
        }
        this.modify_active_media(media_index);
      },
    },
    next_media: {
      ["x-on:click"]() {
        let media_len = Object.keys(this.stories[this.current_story()].media).length - 1;
        let media_index = 0;
        if (this.current_media_index < media_len) {
          media_index = this.current_media_index + 1;
          this.modify_active_media(media_index);
        } else {
          this.stories = {};
        }
      },
    },
    story_progress: {
      ["x-ref"]: "story_progress",
      ["x-init"]() {
        this.$watch("stories", (value) => {
          if (this.$el.innerHTML == "") {
            for (let i = 0; i < Object.keys(this.stories).length; i++) {
              const element = Object.values(this.stories)[i];
              if (element.len()) {
                this.$el.innerHTML = "";
                // Load Story Progress lines
                for (let m = 0; m < element.len(); m++) {
                  const media = element.media[m];
                  let elId = `${media.elementId()}_${element._id}_${m}`;

                  let li = document.createElement("li");
                  let div = document.createElement("div");
                  div.classList.add("line_progress");
                  div.classList.add("w0");
                  div.id = elId;
                  div.setAttribute("x-bind", "progress_item");
                  div.setAttribute("data-id", m);
                  li.setAttribute("x-bind", "progress_item");
                  li.setAttribute("data-id", m);
                  li.appendChild(div);
                  this.$el.appendChild(li);
                }
              }
            }
          }
          for (let i = 0; i < Object.keys(this.stories).length; i++) {
            const element = Object.values(this.stories)[i];
            if (element.len()) {
              // Load Story Progress lines
              for (let m = 0; m < element.len(); m++) {
                const media = element.media[m];
                let elId = `${media.elementId()}_${element._id}_${m}`;

                // Calculate the moving story progress
                let targetElement = document.getElementById(elId);
                let progress_percent = (media.count / media.max_duration) * 100;
                targetElement.style.width = `${progress_percent}%`;
              }
            }
          }
        });
        this.$watch("story_pause", (paused) => {
          if (paused) {
            this.pauseStory(this.current_story(), this.current_media());
          } else {
            this.startAllStories();
          }
        });
      },
    },
    story_caption: {
      ["x-text"]() {
        return this.fetch_media_caption();
      },
    },
    story_user: {
      img: {
        ["x-bind:src"]() {
          return this.fetch_user_details()?.image;
        },
      },
      name: {
        ["x-text"]() {
          return this.fetch_user_details()?.name;
        },
      },
    },
    view_this_story: {
      ["x-on:click"]() {
        let _id = this.$el.getAttribute("data-_id");
        this.story_ctrl = false;
        /* Clear story data */
        this.stories = {};
        /* Reset current media */
        this.current_media_index = 0;
        clearInterval(this.countId);
        this.$refs.story_progress.innerHTML = "";

        let single_story = story_api()[_id];
        single_story._id = Object.keys(this.stories).length;
        this.stories[Object.keys(this.stories).length] = single_story;

        if (this.story_pause) {
          this.pauseStory(this.current_story(), this.current_media());
        } else {
          this.startAllStories();
        }
      },
    },
  }));
  Alpine.data("save_post", () => ({
    post_saved: false,
    save: {
      ["x-on:click"]() {
        this.post_saved = true;
      },
    },
    save_icon: {
      ["x-bind:class"]() {
        return this.post_saved ? "yw" : "";
      },
    },
  }));
  Alpine.data("new_story", () => ({
    visibility: "",
    open: false,
    story_image_active: "",
    active_bottom_img: 0,
    story_images: {
      ["@change"]() {
        const story_images = this.$el.files;
        const imageContainer = this.$refs.story_images;
        imageContainer.innerHTML = "";
        Array.from(story_images).forEach((story_image, key) => {
          if (story_image.type.startsWith("image/")) {
            const li = document.createElement("li");
            const img = document.createElement("img");
            img.src = URL.createObjectURL(story_image);
            img.alt = story_image.name;
            img.setAttribute("x-bind", "story_media");
            const span = document.createElement("span");
            span.innerHTML = key + 1;
            li.appendChild(img);
            li.appendChild(span);
            li.setAttribute("x-bind", "story_list");
            if (key == 0) {
              li.setAttribute("data-selected", "true");
              this.story_image_active = URL.createObjectURL(story_image);
            }
            if (story_images.length > 1) imageContainer.appendChild(li);
          }
        });
      },
    },
    story_list: {
      ["x-bind:data-selected"]() {
        // this.$el.setAttribute('data-index',)
        let parent = this.$el.parentNode;
        const items = Array.from(this.$el.parentNode.children);
        items.forEach((element, key) => {
          element.setAttribute("data-index", key);
        });
        let index = this.$el.getAttribute("data-index");
        return index == this.active_bottom_img;
      },
    },
    story_list_container: {},
    story_media: {
      ["x-on:click"]() {
        this.story_image_active = this.$el.getAttribute("src");
      },
    },
    display_img: {
      ["x-ref"]: "display_image",
      ["x-show"]() {
        if (this.story_image_active != "") {
          this.$el.parentNode.setAttribute("data-active_img", true);
          this.$el.parentNode.children[1].innerHTML = "";
        }
        return this.story_image_active != "";
      },
      ["x-bind:src"]() {
        return this.story_image_active;
      },
    },
    other_story_images: {
      ["x-ref"]: "story_images",
      ["@click"](event) {
        if (event.target && event.target.parentNode.nodeName === "LI") {
          const items = Array.from(this.$el.children);
          const index = items.indexOf(event.target.parentNode);
          this.active_bottom_img = index;
        }
      },
    },
    visible_to: {
      ["@click"]() {
        let target = this.$el;
        this.visibility = target.innerHTML;
        let siblings = target.parentNode.children;
        Object.keys(siblings).forEach((key) => {
          let child = siblings[key];
          child.removeAttribute("data-selected");
        });
        target.setAttribute("data-selected", true);
        return (this.open = !this.open);
      },
    },
    open_panel: {
      ["@click"]() {
        return (this.open = !this.open);
      },
    },
    visibility_menu: {
      ["x-show"]() {
        return this.open;
      },
      ["x-on:click.outside"]() {
        return (this.open = !this.open);
      },
      ["x-transition-origin.center"]() {
        return;
      },
      ["x-transition-duration-500ms"]() {
        return;
      },
    },
  }));

  Alpine.data("explore", () => ({
    user__tab: false,
    send_note: false,
    block_popup: false,
    mobile_menu: false,
    search_input: "",
    filter_menu: "",
    mobile_menu_comment: false,
    likes_favorite: false,
    favorite: false,
    save_post: false,
    share_popup: false,
    reported_popup: false,
    remove_popup: false,
    comments: false,
    image_viewers: false,
    comments_mm: false,
    share_pop: false,
    following_popup: false,
    likes_favorite: false,
    tags_popup: false,
    mobile_add_menu: false,
    notification_tab: "notifications",
    ll__tab: "like",
    ff__tab: "following",
    current_page_ff() {
      return `Search ${this.ff__tab}`;
    },
    share_link: "",
    auth: "",
    push__top: "",
    payment: "",
    view_story: false,
    new_story: false,
    view_history: {
      ["x-on:click"]() {
        if (window.innerWidth <= 640) {
          let story_modal = document.querySelector(".story_modal");
          story_modal.style.display = "flex";
          story_modal.style.transform = "translateY(0%)";
        } else {
          this.view_story = true;
        }
      },
    },
    story_view: {
      ["x-init"]() {
        if (window.innerWidth <= 640) {
          this.$watch("view_story", (value) => {
            if (value) this.$el.style.transform = "translateY(0%)";
            if (!value) this.$el.style.transform = "translateY(150%)";
          });
        }
      },
      ["x-show"]() {
        if (window.innerWidth <= 640) {
          this.$el.style.transform = "translateY(150%)";
          return true;
        } else {
          this.$el.style.transform = "translateY(0%)";
          return this.view_story;
        }
      },
      ["x-on:click.self"]() {
        this.stories = {};
        this.view_story = false;
      },
    },
  }));
  Alpine.data("tabs", () => ({
    my_story_tab: 1,
    tab_len(el) {
      let parent = el.parentNode;
      return parent.querySelectorAll("button").length;
    },
    switch_tab(el) {
      let len = this.tab_len(el);
      return `width: ${(1 / len) * 100}%; transform:translateX(${(this.my_story_tab - 1) * 100}%)`;
    },
    tab_click(num) {
      this.my_story_tab = num;
    },
    bind_data(num) {
      return this.my_story_tab === num;
    },
    __panel(num) {
      return this.my_story_tab === num;
    },
  }));
});
let i = 0;

document.addEventListener("alpine:init", () => {});
